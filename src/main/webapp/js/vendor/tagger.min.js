!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof module&&module.exports?module.exports=e():t.tagger=e()}("undefined"!=typeof window?window:global,function(i){var e,n=(e="innerText"in document.createElement("div")?"innerText":"textContent",function(t){return t[e]});function s(t,e){if(t.length)return Array.from(t).map(function(t){return new s(t,e)});if(!(this instanceof s))return new s(t,e);var n=function i(){if(arguments.length<2)return arguments[0];var t=arguments[0];[].slice.call(arguments).reduce(function(e,n){return a(n)&&Object.keys(n).forEach(function(t){a(n[t])&&a(e[t])?e[t]=i({},e[t],n[t]):e[t]=n[t]}),e});return t}({},s.defaults,e);this.init(t,n)}function a(t){return"object"==typeof t&&null!==t&&"[object Object]"===Object.prototype.toString.call(t)}function o(e,n,t){return e=document.createElement(e),Object.keys(n).forEach(function(t){"style"===t?Object.keys(n.style).forEach(function(t){e.style[t]=n.style[t]}):e.setAttribute(t,n[t])}),t!==i&&t.forEach(function(t){t="string"==typeof t?document.createTextNode(t):o.apply(null,t);e.appendChild(t)}),e}function l(t){return t.replace(/([-\\^$[\]()+{}?*.|])/g,"\\$1")}var _=0;return s.defaults={allow_duplicates:!1,allow_spaces:!0,completion:{list:[],delay:400,min_length:2},tag_limit:-1,add_on_blur:!1,link:function(t){return"/tag/"+t}},s.fn=s.prototype={init:function(t,e){this._id=++_;this._settings=e||{},this._ul=document.createElement("ul"),this._input=t;var n=document.createElement("div");e.wrap?n.className="tagger wrap":n.className="tagger",this._input.setAttribute("hidden","hidden"),this._input.setAttribute("type","hidden");e=document.createElement("li");e.className="tagger-new",this._new_input_tag=document.createElement("input"),this.tags_from_input(),e.appendChild(this._new_input_tag),this._completion=document.createElement("div"),this._completion.className="tagger-completion",this._ul.appendChild(e),t.parentNode.replaceChild(n,t),n.appendChild(t),n.appendChild(this._ul),e.appendChild(this._completion),this._add_events(),this._settings.completion.list instanceof Array&&this._build_completion(this._settings.completion.list)},_add_events:function(){var i=this;this._ul.addEventListener("click",function(t){t.target.className.match(/close/)&&(i._remove_tag(t.target),t.preventDefault())}),this._settings.add_on_blur&&this._new_input_tag.addEventListener("blur",function(t){i.add_tag(i._new_input_tag.value.trim())&&(i._new_input_tag.value="")}),this._new_input_tag.addEventListener("keydown",function(t){var e;13===t.keyCode||188===t.keyCode||32===t.keyCode&&!i._settings.allow_spaces?(i.add_tag(i._new_input_tag.value.trim())&&(i._new_input_tag.value=""),t.preventDefault()):8!==t.keyCode||i._new_input_tag.value?32===t.keyCode&&(t.ctrlKey||t.metaKey)?("function"==typeof i._settings.completion.list&&i.complete(i._new_input_tag.value),i._toggle_completion(!0),t.preventDefault()):i._tag_limit()&&t.preventDefault():(0<i._tags.length&&(e=i._ul.querySelector("li:nth-last-child(2)"),i._ul.removeChild(e),i._tags.pop(),i._input.value=i._tags.join(",")),t.preventDefault())}),this._new_input_tag.addEventListener("input",function(t){var e,n=i._new_input_tag.value;i._tag_selected(n)?i.add_tag(n)&&(i._toggle_completion(!1),i._new_input_tag.value=""):("function"==typeof i._settings.completion.list&&i.complete(n),e=i._settings.completion.min_length,i._toggle_completion(n.length>=e))}),this._completion.addEventListener("click",function(t){"a"===t.target.tagName.toLowerCase()&&(i.add_tag(n(t.target)),i._new_input_tag.value="",i._completion.innerHTML="")})},_tag_selected:function(t){if(this._last_completion&&this._last_completion.includes(t)){var e=new RegExp("^"+l(t));return 1===this._last_completion.filter(function(t){return e.test(t)}).length}return!1},_toggle_completion:function(t){t?this._new_input_tag.setAttribute("list","tagger-completion-"+this._id):this._new_input_tag.removeAttribute("list")},_build_completion:function(t){this._completion.innerHTML="",(this._last_completion=t).length&&(t=o("datalist",{id:"tagger-completion-"+this._id},t.map(function(t){return["option",{},[t]]})),this._completion.appendChild(t))},complete:function(t){var e;this._settings.completion&&("function"==typeof(e=this._settings.completion.list)?(t=e(t))&&"function"==typeof t.then?t.then(this._build_completion.bind(this)):t instanceof Array&&this._build_completion(t):this._build_completion(e))},tags_from_input:function(){this._tags=this._input.value.split(/\s*,\s*/).filter(Boolean),this._tags.forEach(this._new_tag.bind(this))},_new_tag:function(t){var e=["a",{href:"#",class:"close"},["Ã—"]],n=["span",{class:"label"},[t]],t=this._settings.link(t);e=o("li",{},!1===t?[["span",{},[n,e]]]:[["a",{href:t,target:"_black"},[n,e]]]),this._ul.insertBefore(e,this._new_input_tag.parentNode)},_tag_limit:function(){return 0<this._settings.tag_limit&&this._tags.length>=this._settings.tag_limit},add_tag:function(t){if(!this._settings.allow_duplicates&&-1!==this._tags.indexOf(t))return!1;if(this._tag_limit())return!1;if(this.is_empty(t))return!1;this._new_tag(t),this._tags.push(t),this._input.value=this._tags.join(",");const e=document.createEvent("HTMLEvents");return e.initEvent("add_tag",!1,!0),e.item=t,this._input.dispatchEvent(e),!0},is_empty:function(t){switch(t){case"":case'""':case"''":case"``":case i:case null:return!0;default:return!1}},remove_tag:function(e,t=!0){this._tags=this._tags.filter(function(t){return e!==t}),this._input.value=this._tags.join(",");const n=document.createEvent("HTMLEvents");if(n.initEvent("remove_tag",!1,!0),n.item=e,this._input.dispatchEvent(n),t){var t=Array.from(this._ul.querySelectorAll(".label")),i=new RegExp("^s*"+l(e)+"s*$"),t=t.find(function(t){return t.innerText.match(i)});if(!t)return!1;t=t.closest("li");return this._ul.removeChild(t),!0}},_remove_tag:function(t){var e=t.closest("li"),t=e.querySelector(".label").innerText;this._ul.removeChild(e),this.remove_tag(t,!1)}},s});
