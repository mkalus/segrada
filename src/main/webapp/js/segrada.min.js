function escapeHTML(t){return"string"==typeof t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}!function(s){var n=function(a){return function(t,e){t=s.ajax({url:a+encodeURIComponent(t),async:!1});e(JSON.parse(t.responseText))}},e=function(){return function(t,e){var a=urlSegradaNodeSearch+encodeURIComponent(t),t=s(".sg-node-search").filter(":focus"),t=s("#"+t.attr("data-select-id")+" option").filter(":selected").attr(t.attr("data-attr"));null!=t&&0<t.length&&(a+="&tags="+encodeURIComponent(t));a=s.ajax({url:a,async:!1});e(JSON.parse(a.responseText))}};function t(t){return t.replace(/;jsessionid=([^?]*)/,"")}urlSegradaPictogramSearch=t(urlSegradaPictogramSearch),urlSegradaPictogramFile=t(urlSegradaPictogramFile),urlSegradaTagSearch=t(urlSegradaTagSearch),urlSegradaNodeSearch=t(urlSegradaNodeSearch),urlSegradaFileSearch=t(urlSegradaFileSearch),urlSegradaSourceSearch=t(urlSegradaSourceSearch),urlSegradaRelationAdd=t(urlSegradaRelationAdd);var r=!1,o=new vis.DataSet([]),l=new vis.DataSet([]),d=null,i=null,c=null;s.fn.onEnter=function(e){return this.bind("keypress",function(t){13==t.keyCode&&e.apply(this,[t])}),this};var u=new RegExp(/<([^\s]+).*?id="([^"]*?)".*?>/i);function a(r,e,i,o,t){t=urlSegradaPictogramSearch+encodeURIComponent(t);s.getJSON(t,function(t){var n=[];s.each(t,function(t,e){var a=s("<div/>").text(e.title).html();n.push('<div class="col-xs-1 sg-no-padding-right"><a class="sg-pictogram-modal-link" href="#" data-id="'+e.id+'" data-uid="'+e.uid+'" title="'+a+'"><img src="'+urlSegradaPictogramFile+e.uid+'" width="24" height="24" alt="'+a+'" /></a></div>')}),e.html("<div class='row'>"+n.join("")+"</div>"),s("a",e).click(function(t){var e=s(this).attr("data-id"),a=s(this).attr("data-uid"),n=s("<div/>").text(s(this).attr("title")).html();s("#value-"+i,o).val(e),s("#preview-"+i,o).html('<img src="'+urlSegradaPictogramFile+a+'" width="24" height="24" alt="'+n+'" /> '+n),s("#clear-"+i,o).show(),t.preventDefault(),r.modal("hide")})}).fail(function(){alert("ERROR")})}function h(t){s.get(t,function(t){var e=t.match(u);null!=e&&2<=e.length&&s("#"+e[2]).remove();e=s("#sg-data");e.prepend(t);e=e.children(":first");g(e),s("html, body").animate({scrollTop:e.offset().top},500)}).fail(function(){alert("ERROR")})}function g(o){o=o||s("body"),s(".sg-data").addClass("sg-dynamic-data"),s(".sg-headbox-right").show(),s(".sg-dynamic-hide").hide(),s(".sg-data-add",o).click(function(t){h(s(this).attr("href")),t.preventDefault()}),s(".sg-control-form",o).ajaxForm({beforeSubmit:function(t,e,a){e=e.attr("data-target-id");void 0!==e&&null!=e&&0!=e.length||(e="#sg-control",p());e=s(e);return e.wrapInner("<div class='sg-disabled'></div>"),e.prepend(s("#sg-wait").html()),!0},success:function(t,e,a,n){n=n.attr("data-target-id");void 0!==n&&null!=n&&0!=n.length||(n="#sg-control");n=s(n);n.html(t),g(n)},error:function(t,e,a,n){n=n.attr("data-target-id");void 0!==n&&null!=n&&0!=n.length||(n="#sg-control"),s(n).html(t.statusText),alert("Error "+t.status+"\n"+t.statusText)}}),s(".sg-submit-form",o).change(function(){s(this).closest("form").submit()}),s(".sg-control-set",o).click(function(t){var e=s(this),a=e.attr("data-target-id");void 0!==a&&null!=a&&0!=a.length||(a="#sg-control",p());var n=s(a);n.wrapInner("<div class='sg-disabled'></div>"),n.prepend(s("#sg-wait").html()),s.get(e.attr("href"),function(t){n.html(t),g(n)}).fail(function(){alert("ERROR")}),t.preventDefault()}),s("[data-data-dblclick]",o).dblclick(function(){s.get(s(this).attr("data-data-dblclick"),function(t){var e=t.match(u);null!=e&&2<=e.length&&s("#"+e[2]).remove();e=s("#sg-data");e.prepend(t);e=e.children(":first");g(e),s("html, body").animate({scrollTop:e.offset().top},500)}).fail(function(){alert("ERROR")})}),s("tr [data-confirm]",o).click(function(t){var e,a=s(this);confirm(a.attr("data-confirm"))&&((e=a.closest("tr")).addClass("sg-disabled"),s.get(a.attr("href"),function(t){e.slideUp("fast",function(){e.remove()})}).fail(function(){alert("ERROR")})),t.preventDefault()}),s(".sg-control-confirm",o).click(function(t){var e,a=s(this);confirm(a.attr("data-confirm"))&&((e=s("#"+a.attr("data-target"))).addClass("sg-disabled"),s.get(a.attr("href"),function(t){e.fadeOut("slow",function(){e.remove()})}).fail(function(){alert("ERROR")})),t.preventDefault()}),s(".sg-replace-content",o).on("shown.bs.tab",function(t){var e=s(s(this).attr("href")),a=s(this).attr("data-url");s.get(a,function(t){e.html(t),g(e)}).fail(function(){alert("ERROR")}),s(this).removeClass("sg-replace-content"),s(this).unbind("shown.bs.tab")}),s(".sg-data-close",o).click(function(t){s(this).parent().parent().fadeOut("fast",function(){s(this).remove()})}),s("input.sg-fileupload",o).fileinput({showUpload:!1}),s("input.sg-fileupload-small",o).fileinput({showUpload:!1,previewSettings:{image:{width:"auto",height:"24px"}}}),s(".sg-pictogram-modal",o).on("shown.bs.modal",function(){var n=s(this),r=n.attr("id"),i=s("#container-"+r,n),t=s("#filter-"+r,n);t.on("input propertychange paste",function(){a(n,i,r,o,s(this).val())}).onEnter(function(){var t,e,a=s(".sg-pictogram-modal-link",i).first();0<a.length&&(t=a.attr("data-id"),e=a.attr("data-id"),a=s("<div/>").text(a.attr("title")).html(),s("#value-"+r,o).val(t),s("#preview-"+r,o).html('<img src="'+urlSegradaPictogramFile+e+'" width="24" height="24" alt="'+a+'" /> '+a),s("#clear-"+r,o).show(),n.modal("hide"))}),""===t.val()&&a(n,i,r,o,"")}),s(".sg-pictogram-chooser",o).click(function(t){s("#"+s(this).attr("data-id")).modal("show"),t.preventDefault()}),s(".sg-pictogram-clearer",o).click(function(t){var e=s(this).attr("data-id");s("#value-"+e,o).val(""),s("#preview-"+e,o).html(""),s(this).hide(),t.preventDefault()}),s(".sg-source-ref-modal",o).on("shown.bs.modal",function(){var i=s(this),e=(i.attr("id"),s(".modal-body",i));s.get(i.attr("data-href"),function(t){e.html(t),s("form",e).ajaxForm({beforeSubmit:function(t,e,a){return e.wrapInner("<div class='sg-disabled'></div>"),e.prepend(s("#sg-wait").html()),!0},success:function(t,e,a,n){var r=s(i.attr("data-target"));r.html(t),g(r),i.modal("hide")},error:function(t,e,a,n){alert("Error "+t.status+"\n"+t.statusText)}})}).fail(function(){alert("ERROR")})}).on("hidden.bs.modal",function(){s(".modal-body",s(this)).html(s("#sg-wait").html())}),s(".sg-source-ref-editor",o).click(function(t){var e=s("#"+s(this).attr("data-id"));e.attr("data-href",s(this).attr("href")),e.modal("show"),t.preventDefault()}),s(".sg-taglist-contract",o).each(function(){var t=s("span",s(this));1<t.length&&(t.hide().filter(":first-child").show().after('<span class="sg-tag-show label label-default"><i class="fa fa-plus"></i></span>'),s("span.sg-tag-show",s(this)).click(function(){s(this).remove(),t.show()}))}),s("select.sg-colorpicker",o).simplepicker({theme:"fontawesome"}),s("select.sg-tags",o).each(function(){var e=s(this);e.tagsinput({trimValue:!0,confirmKeys:[13],typeaheadjs:{name:"tags",limit:25,displayKey:"title",valueKey:"title",source:n(urlSegradaTagSearch)}}),e.on("itemRemoved",function(t){e.find('option[value="'+t.item+'"]').remove()})}),s("input.sg-node-search",o).each(function(){var t=s(this),a=s("#"+t.attr("data-id"));t.typeahead({hint:!0,highlight:!0,minLength:1},{async:!0,name:"node",limit:25,displayKey:"title",valueKey:"id",source:e()}).bind("typeahead:selected",function(t,e){a.val(e.id)}).bind("keyup",function(){this.value||a.val("")})}),s("input.sg-file-search",o).each(function(){var t=s(this),a=s("#"+t.attr("data-id"));t.typeahead({hint:!0,highlight:!0,minLength:1},{async:!0,name:"file",limit:25,displayKey:"title",valueKey:"id",source:n(urlSegradaFileSearch)}).bind("typeahead:selected",function(t,e){a.val(e.id)}).bind("keyup",function(){this.value||a.val("")})}),s("input.sg-source-search",o).each(function(){var t=s(this),a=s("#"+t.attr("data-id"));t.typeahead({hint:!0,highlight:!0,minLength:1},{async:!0,name:"source",limit:25,displayKey:"title",valueKey:"id",source:n(urlSegradaSourceSearch)}).bind("typeahead:selected",function(t,e){a.val(e.id)}).bind("keyup",function(){this.value||a.val("")})}),s(".sg-link-external",o).click(function(t){var e=s(this).attr("href");window.open(e,"_blank").focus(),t.preventDefault()}),s("form.sg-data-form",o).ajaxForm({beforeSubmit:function(t,e,a){return s(":input",e).attr("disabled",!0),s("button.btn-primary",e).append(" "+s("#sg-wait-btn").html()),!0},success:function(t,e,a,n){var r=n.attr("data-id");(r=(r=void 0!==r?s("#"+r):r)||n).replaceWith(t);t=t.match(u);null!=t&&2<=t.length&&g(s("#"+t[2]))},error:function(t,e,a,n){s(":input",n).attr("disabled",!1),alert("Error "+t.status+"\n"+t.statusText)}}),s("form.sg-simple-form",o).ajaxForm({beforeSubmit:function(t,e,a){s(":input",e).attr("disabled",!0);var n=e.attr("data-id");return(n=(n=void 0!==n?s("#"+n):n)||e).html(s("#sg-wait")),!0},success:function(t,e,a,n){var r=n.attr("data-id");(r=(r=void 0!==r?s("#"+r):r)||n).html(t),s(":input",n).attr("disabled",!1)},error:function(t,e,a,n){s(":input",n).attr("disabled",!1),alert("Error "+t.status+"\n"+t.statusText)}}),s(".sg-periods").each(function(){var r=s(this),i=r.attr("id"),t=s(".sg-period-form",r);s(".sg-period-add",r).click(function(t){s(this).hide();var e=s(".sg-period-form-add",r);e.show(),s(".sg-period-form-period",e).change(function(t){s(this).is(":checked")?s(".sg-period-toggle",e).show():s(".sg-period-toggle",e).hide()}),t.preventDefault()}),t.ajaxForm({beforeSubmit:function(t,e,a){return r.addClass("disabled"),!0},success:function(t,e,a,n){r.replaceWith(t),g(s("#"+i))},error:function(t,e,a,n){r.removeClass("disabled"),alert("Error "+t.status+"\n"+t.statusText)}})}),s(".sg-ajax-modal",o).click(function(t){var e=s("#sg-modal"),a=s(".modal-body-inner",e),n=s(".modal-loading",e);s("h4",e).html(s(this).attr("data-title")),a.html(""),a.hide(),n.show(),e.modal("show"),s.get(s(this).attr("href"),function(t){n.hide(),a.html(t),a.show(),g(a)}).fail(function(){alert("ERROR")}),t.preventDefault()}),s(".sg-ajax-modal-form",o).ajaxForm({beforeSubmit:function(t,e,a){var n=s("#sg-modal"),r=s(".modal-body-inner",n),n=s(".modal-loading",n);return r.hide(),n.show(),!0},success:function(t,e,a,n){var r=s("#sg-modal"),i=s(".modal-body-inner",r),o=s(".modal-loading",r);i.html(t),i.show(),o.hide(),g(i),r=s("#sg-modal"),s(".sg-update-period",r).each(function(){var t=s(this).attr("data-id"),e=s(t);if(0<e.length)for(var a=0;a<3;a++)s("td:eq("+a+")",e).html(s("div:eq("+a+")",s(this)).html())})},error:function(t,e,a,n){var r=s("#sg-modal"),i=s(".modal-body-inner",r),r=s(".modal-loading",r);i.html(t),i.show(),r.hide(),g(i)}}),s(".sg-plain-editor",o).click(function(t){s(s(this).attr("data-editor")).summernote("destroy")}),s(".sg-html-editor",o).each(function(){var t=s("html").attr("lang"),e={lang:t="en"===t?"en-US":t},t=s(this),a=s(t.attr("data-editor"));t.attr("checked")&&a.summernote(e),t.click(function(t){a.summernote(e)})}),s(".sg-lg-image",o).each(function(){var t=s(this).attr("id");t&&new Viewer(document.getElementById(t),{navbar:!1,toolbar:{zoomIn:1,zoomOut:1,oneToOne:1,reset:1,prev:0,play:{show:1,size:"large"},next:0,rotateLeft:1,rotateRight:1,flipHorizontal:1,flipVertical:1}})}),s("a.sg-graph-update",o).click(function(t){v(s(this).attr("href")),t.preventDefault()}),s("a.sg-graph-replace",o).click(function(t){b(),v(s(this).attr("href"));var e=s(this).attr("data-title");0!=e.length&&(i=e);e=s(this).attr("data-uid");0!=e.length&&(c=e),t.preventDefault()}),s("div.sg-tag-hierarchy",o).each(function(){var t=s(this),e=s(".sg-tag-hierarchy-graph",t);s(".sg-child-tags",t).hide(),e.addClass("sg-margin-top sg-margin-bottom");var t=s(".sg-tag-hierarchy-data",t),n=t.attr("data-center"),r=0,i=0,o=[],l=[];s("div",t).each(function(){var t=s(this),e=t.attr("data-id"),a=t.attr("data-level");o.push({id:e,label:t.html(),level:a,url:t.attr("data-url")}),"0"==a?(l.push({from:e,to:n}),r++):"2"==a&&(l.push({from:n,to:e}),i++)});t=i<r?0==r?1:r:i;e.css({width:"100%",height:50*t+"px",border:"1px solid #ccc"});var a={nodes:new vis.DataSet(o),edges:new vis.DataSet(l)},o=null,l=null;new vis.Network(e.get(0),a,{edges:{smooth:{type:"cubicBezier",forceDirection:"horizontal",roundness:.6}},nodes:{shape:"box"},layout:{hierarchical:{direction:"LR"}}}).on("doubleClick",function(t){var e=null;0<t.nodes.length&&(null!=(t=a.nodes.get(t.nodes[0]))&&null!=t.url&&(e=t.url)),null!=e&&h(e)})});for(var t=0;t<afterAjaxHooks.length;t++)afterAjaxHooks[t](o)}function f(){var t,e,a;r||(r=!0,t=document.getElementById("sg-graph"),e={nodes:o,edges:l},a={locale:s("html").attr("lang"),locales:{de:{edit:"Änderungsmodus",del:"Lösche Auswahl",back:"Zurück",addNode:"Knoten hinzufügen",addEdge:"Verknüpfung hinzufügen",editNode:"Knoten editieren",editEdge:"Verknüpfung editieren",addDescription:"Klicke auf eine freie Stelle, um einen neuen Knoten zu plazieren.",edgeDescription:"Klicke auf einen Knoten und ziehe die Verknüpfung zu einem anderen Knoten, um diese zu verbinden.",editEdgeDescription:"Klicke auf die Verbindungspunkte und ziehe diese auf einen Knoten, um sie zu verbinden.",createEdgeError:"Es ist nicht möglich, Verknüpfungen mit Clustern zu verbinden.",deleteClusterError:"Cluster können nicht gelöscht werden.",editClusterError:"Cluster können nicht editiert werden."},en:{edit:"Toggle edit",del:"Delete selected",back:"Back",addNode:"Add Node",addEdge:"Add Relation",editNode:"Edit Node",editEdge:"Edit Relation",addDescription:"Click in an empty space to place a new node.",edgeDescription:"Click on a node and drag the relation to another node to connect them.",editEdgeDescription:"Click on the control points and drag them to a node to connect to it.",createEdgeError:"Cannot link relations to a cluster.",deleteClusterError:"Clusters cannot be deleted.",editClusterError:"Clusters cannot be edited."}},manipulation:{enabled:!0,addNode:!1,addEdge:function(t,e){return h(urlSegradaRelationAdd.replace("XFROMX",t.from.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("XTOX",t.to.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("&amp;","&")),!1},editNode:function(t,e){return!1},editEdge:function(t,e){return!1},deleteNode:function(t,e){return!1},deleteEdge:function(t,e){return!1}},nodes:{shape:"icon",color:{border:"#000",background:"#fff"}},edges:{font:{size:10},labelHighlightBold:!1,selectionWidth:0,arrows:{to:!0},smooth:{type:"cubicBezier"}},groups:{node:{icon:{code:"",color:"#000000"}},tag:{shape:"box",color:{border:"#5bc0de",background:"#5bc0de",highlight:{background:"#2B7CE9"}},font:{color:"#ffffff",size:12}}},physics:{barnesHut:{springLength:120}}},(d=new vis.Network(t,e,a)).on("doubleClick",function(t){var e,a=null;0<t.nodes.length?null!=(e=o.get(t.nodes[0]))&&null!=e.url&&(a=e.url):0<t.edges.length&&(null!=(t=l.get(t.edges[0]))&&null!=t.url&&(a=t.url)),null!=a&&h(a)}))}function p(){var t=s("#sg-toggle-graph");t.hasClass("active")&&(t.removeClass("active"),s(".fa-share-alt-square",t).addClass("fa-share-alt").removeClass("fa-share-alt-square"),d.storePositions(),s("#sg-graph-container").hide(),s("#sg-control").show(),d.destroy(),r=!1)}function m(){var t=s("#sg-toggle-graph");t.hasClass("active")||(t.addClass("active"),s(".fa-share-alt",t).addClass("fa-share-alt-square").removeClass("fa-share-alt"),s("#sg-control").hide(),s("#sg-graph-container").show(),f())}function v(t){if(null!=t){m(),(i=s("#sg-graph")).css("background",'url("'+i.attr("data-bg")+'") no-repeat center center');for(var e=[],a=[],n=o.get({fields:["id"]}),r=0;r<n.length;r++)e.push(n[r].id);for(n=l.get({fields:["id"]}),r=0;r<n.length;r++)a.push(n[r].id);var i=s("#sg-graph-container").attr("data-csrf");s.ajax({url:t,type:"POST",dataType:"json",headers:{"Content-Type":"application/json","X-CSRF-Token":i},data:JSON.stringify({nodes:e,edges:a}),success:function(t,e,a){s("#sg-graph").css("background","transparent"),null!=t?null==t.error?(null!=t.nodes&&0<t.nodes.length&&o.update(t.nodes),null!=t.edges&&0<t.edges.length&&l.update(t.edges),null!=t.removeNodes&&0<t.removeNodes.length&&o.remove(t.removeNodes),null!=t.removeEdges&&0<t.removeEdges.length&&l.remove(t.removeEdges),null!=t.highlightNode&&(d.unselectAll(),d.selectNodes([t.highlightNode],!1)),d.fit()):alert(t.error):alert("NULL data")}})}else alert("Null url!")}function b(){l.clear(),o.clear(),i=c=""}s.event.special.destroyed={remove:function(t){t.handler&&t.handler()}},s(document).ready(function(){s("#sg-close-all").click(function(t){s(".sg-data").fadeOut("fast",function(){s(this).remove()}),t.preventDefault()}),s(".sg-locale").click(function(t){s.get(s(this).attr("href"),function(t){var e=s("#sg-base").html();""!=t&&(window.location.href=e)}).fail(function(){alert("ERROR")}),t.preventDefault()}),s("#sg-toggle-graph").click(function(t){(s(this).hasClass("active")?p:m)(),t.preventDefault()}),s("#sg-graph-action-remove").click(function(t){var e=d.getSelection();0<e.edges.length&&l.remove(e.edges),0<e.nodes.length&&o.remove(e.nodes),t.preventDefault()}),s("#sg-graph-action-restart").click(function(t){b(),t.preventDefault()}),s("#sg-graph-action-reload").click(function(t){d.destroy(),r=!1,f(),t.preventDefault()}),s("#sg-graph-action-fit").click(function(t){d.fit(),t.preventDefault()}),s("#sg-graph-close").click(function(t){p(),t.preventDefault()}),s("#sg-graph-action-load").click(function(t){s("#sg-graph-modal-load").modal(),t.preventDefault()}),s("#sg-graph-action-save").click(function(t){var e;0<o.length&&(s("#title-sg-graph-save").val(null!==i?i:""),e=s("#save-as-new-sg-graph-save").parent().parent().parent(),null!==c?e.show():e.hide(),s("#sg-graph-modal-save").modal()),t.preventDefault()}),s("#sg-graph-modal-load").on("shown.bs.modal",function(){var n=s(this),r=s(".modal-body",n);r.html(s("#sg-wait").html());var t=n.attr("data-url");s.get(t,function(t){var e=n.attr("data-get-url"),a="";t.forEach(function(t){a+="<li><a href='"+e+t.uid+"' data-uid='"+t.uid+"'>"+t.title+"</a></li>"}),""!=a&&(a="<ul>"+a+"</ul>"),r.html(a),s("a",r).click(function(t){b(),v(s(this).attr("href")),i=s(this).html(),c=s(this).attr("data-uid"),n.modal("hide"),t.preventDefault()})})}),s("#sg-graph-modal-save-frm").submit(function(t){t.preventDefault();var e=s("#title-sg-graph-save").val(),t=c;null!=c&&s("#save-as-new-sg-graph-save").is(":checked")&&(t=null),d.storePositions();var a=[],n=[];o.forEach(function(t){a.push({id:t.id,x:t.x,y:t.y,group:t.group})}),l.forEach(function(t){n.push({id:t.id,group:t.group})});s.post(s(this).attr("action"),{_csrf:s("#sg-graph-container").attr("data-csrf"),uid:t,title:e,type:"graph",data:JSON.stringify({nodes:a,edges:n})},function(t){i=e,c=t}).fail(function(){alert("ERROR")}),s("#sg-graph-modal-save").modal("hide")}),g(s("body"))})}(jQuery);
