!function(h){var e=new Bloodhound({datumTokenizer:function(t){return Bloodhound.tokenizers.whitespace(t.title)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:"http://nominatim.openstreetmap.org/search?format=json&q=%QUERY",transform:function(t){for(var e=[],n=0;n<t.length;n++)e.push({title:t[n].display_name,lng:t[n].lon,lat:t[n].lat});return e}}});function d(t,r){r.clear(!0),console.log(r),h(".sg-location-marker",t).each(function(){var t,e,n,a,o,i;t=h(this),e=r,n=parseFloat(t.attr("data-lat")),a=parseFloat(t.attr("data-lng")),o=void 0!==(o=t.attr("data-comment"))&&""!=o?"<p>"+escapeHTML(o)+"</p>":"",i=new ol.geom.Point(ol.proj.transform([a,n],"EPSG:4326","EPSG:3857")),o=new ol.Feature({geometry:i,data_id:t.html(),lat:n,lng:a,delete_ok:"1"===t.attr("data-delete-ok"),delete_url:t.attr("data-delete"),comment:o}),e.addFeature(o)})}function t(t){t=t||h("body"),h(".sg-geotab",t).on("shown.bs.tab",function(t){var o,i,r,l,s,c,p,u,t=h(t.target);"1"!=t.attr("data-created")&&(t.attr("data-created","1"),o=t.attr("data-locations-id"),i=h("#"+o),r=h(".sg-map-form",i),l=h(".sg-geocomplete",r),s=h("#"+o+"-markers",i),c=h("#"+o+"-delete").html(),p=new ol.source.Vector({}),d(s,p),t=new ol.style.Style({image:new ol.style.Icon({anchor:[12,12],anchorXUnits:"pixels",anchorYUnits:"pixels",opacity:.75,src:urlSegradaBasepath+"img/marker-icon.png"})}),(u=new ol.Map({layers:[new ol.layer.Tile({source:new ol.source.Stamen({layer:"terrain-background"})}),new ol.layer.Vector({source:p,style:t})],view:new ol.View({center:[0,0],zoom:1}),target:o+"-map"})).on("singleclick",function(t){u.forEachFeatureAtPixel(t.pixel,function(n,t){var a=new ol.Overlay.Popup;u.addOverlay(a);var e="<p>"+n.get("lat")+","+n.get("lng")+"</p>";e+=n.get("comment"),n.get("delete_ok")&&(e+='<p><a href="'+n.get("delete_url")+'" id="x'+n.get("data_id")+'-delete" data-action="delete">'+c+"</a></p>"),a.show(n.getGeometry().getCoordinates(),e),a.getElement().addEventListener("click",function(t){var e;"delete"==t.target.getAttribute("data-action")&&(e=h("#"+o+"-delete-confirm").html().replace("{0}",n.get("lat")+","+n.get("lng")),confirm(e)&&(h.get(n.get("delete_url"),function(t){s.replaceWith(t),d(s=h("#"+o+"-markers",i),p)}),a.hide()),t.preventDefault())},!1)})}),u.on("dblclick",function(t){var e,n,a=h(".sg-location-dbl-click",i);0<a.length&&(e=ol.proj.transform(t.coordinate,"EPSG:3857","EPSG:4326"),n=a.attr("data-confirm").replace("{0}",e[1]+","+e[0]),confirm(n)&&(a=r.attr("action"),n=h("input[name=_csrf]").val(),h.post(a,{_csrf:n,lng:e[0],lat:e[1],comment:""},function(t,e,n){s.replaceWith(t),d(s=h("#"+o+"-markers",i),p)}),t.preventDefault()))}),h(".sg-map-add-marker",i).click(function(t){h(this).parent().hide(),r.show(),t.preventDefault()}),l.typeahead({hint:!0,highlight:!0,minLength:3},{name:"address-suggest-"+o,displayKey:"title",limit:25,valueKey:"id",source:e.ttAdapter()}).bind("typeahead:selected",function(t,e){l.val(e.title),h("input[name=lat]",r).val(e.lat),h("input[name=lng]",r).val(e.lng),h("input[type=submit]",r).show()}).bind("keyup",function(){this.value||(l.val(""),h("input[name=lat]",r).val(""),h("input[name=lng]",r).val(""),h("input[type=submit]",r).hide())}),r.ajaxForm({beforeSubmit:function(t,e,n){return i.addClass("disabled"),!0},success:function(t,e,n,a){i.removeClass("disabled"),s.replaceWith(t),d(s=h("#"+o+"-markers",i),p),l.val(""),h("input[name=lat]",r).val(""),h("input[name=lng]",r).val(""),h("input[name=comment]",r).val(""),h("input[type=submit]",r).hide()},error:function(t,e,n,a){i.removeClass("disabled"),alert("Error "+t.status+"\n"+t.statusText)}}))})}h(document).ready(function(){afterAjaxHooks.push(t)})}(jQuery),ol.Overlay.Popup=function(t){t=t||{};this.panMapIfOutOfView=t.panMapIfOutOfView,void 0===this.panMapIfOutOfView&&(this.panMapIfOutOfView=!0),this.ani=t.ani,void 0===this.ani&&(this.ani=ol.animation.pan),this.ani_opts=t.ani_opts,void 0===this.ani_opts&&(this.ani_opts={duration:250}),this.container=document.createElement("div"),this.container.className="ol-popup",this.closer=document.createElement("a"),this.closer.className="ol-popup-closer",this.closer.href="#",this.container.appendChild(this.closer);var e=this;this.closer.addEventListener("click",function(t){e.container.style.display="none",e.closer.blur(),t.preventDefault()},!1),this.content=document.createElement("div"),this.content.className="ol-popup-content",this.container.appendChild(this.content),ol.Overlay.Popup.enableTouchScroll_(this.content),ol.Overlay.call(this,{element:this.container,stopEvent:!0,insertFirst:!t.hasOwnProperty("insertFirst")||t.insertFirst})},ol.inherits(ol.Overlay.Popup,ol.Overlay),ol.Overlay.Popup.prototype.show=function(t,e){return this.setPosition(t),this.content.innerHTML=e,this.container.style.display="block",this.panMapIfOutOfView&&this.panIntoView_(t),this.content.scrollTop=0,this},ol.Overlay.Popup.prototype.panIntoView_=function(t){var e=this.getElement().clientWidth+20,n=this.getElement().clientHeight+20,a=this.getMap().getSize(),o=e-60,i=this.getOffset(),r=this.getMap().getPixelFromCoordinate(t),e=r[0]-60,t=a[0]-(r[0]+o),o=r[1]-n+i[1],n=a[1]-(r[1]+20)-i[1],a=this.getMap().getView().getCenter(),r=this.getMap().getPixelFromCoordinate(a),i=r.slice();return t<0?i[0]-=t:e<0&&(i[0]+=e),o<0?i[1]+=o:n<0&&(i[1]-=n),this.ani&&this.ani_opts&&(this.ani_opts.source=a,this.getMap().beforeRender(this.ani(this.ani_opts))),i[0]===r[0]&&i[1]===r[1]||this.getMap().getView().setCenter(this.getMap().getCoordinateFromPixel(i)),this.getMap().getView().getCenter()},ol.Overlay.Popup.isTouchDevice_=function(){try{return document.createEvent("TouchEvent"),!0}catch(t){return!1}},ol.Overlay.Popup.enableTouchScroll_=function(t){var e;ol.Overlay.Popup.isTouchDevice_()&&(e=0,t.addEventListener("touchstart",function(t){e=this.scrollTop+t.touches[0].pageY},!1),t.addEventListener("touchmove",function(t){this.scrollTop=e-t.touches[0].pageY},!1))},ol.Overlay.Popup.prototype.hide=function(){return this.container.style.display="none",this};
